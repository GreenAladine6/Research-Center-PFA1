{% extends "user.html" %}

{% block head %} 
    <title>Dashboard | Projects</title>
    <link href="{{ url_for('dashboard.static', filename='css/style1.css') }}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{{ url_for('dashboard.static', filename='css/project-style.css') }}">
    <style>
        .profile-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #dee2e6;
        }
        .project-card {
            transition: transform 0.2s;
        }
        .project-card:hover {
            transform: translateY(-5px);
        }
        .project-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px 5px 0 0;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
        }
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .btn-cancel {
            background-color: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">User Profile</h1>
    
    <!-- Profile Picture and Info -->
    <div class="card mb-4">
        <div class="card-body text-center">
            {% if user and user.IMAGE %}
                <img src="{{ url_for('static', filename=user.IMAGE) }}" alt="Profile Picture" class="profile-img mb-3">
            {% else %}
                <img src="{{ url_for('static', filename='images/uploads/staff/avatar-placeholder.png') }}" alt="Profile Picture" class="profile-img mb-3">
            {% endif %}
            <h4>{{ user.FULL_NAME if user and user.FULL_NAME else 'Unknown User' }}</h4>
            <h5>{{ grade.NAME_GRADE if user and user.ID_GRADE else 'No Grade' }}</h5>
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#updateProfileModal">Update Profile</button>
                <button id="openAddModal" class="btn btn-primary mt-2">
                    <i class="fas fa-plus me-2"></i>Add Project
                </button>
                <button id="openQuitModal" class="btn btn-danger mt-2">
                    <i class="fas fa-sign-out-alt me-2"></i>Quit Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Projects Section -->
    <h2 class="mb-3">Your Projects</h2>
    {% if projects %}
    <div class="projects-grid">
        {% for p in projects %}
        
        <div class="project-card" 
             data-project-id="{{ p.id }}"
             data-name="{{ p.NAME_PROJECT if p.NAME_PROJECT else '' }}"
             data-user="{{ p.ID_MANAGER if p.ID_MANAGER else '' }}"
             data-date-begin="{{ p.DATE_BEGIN if p.DATE_BEGIN else '' }}"
             data-date-end="{{ p.DATE_END if p.DATE_END else '' }}"
             data-state="{{ p.STATE if p.STATE else 'Not Started' }}"
             data-budget="{{ p.BUDGET if p.BUDGET else '0.00' }}"
             data-image="{{ url_for('static', filename=p.IMAGE) if p.IMAGE else '' }}">
            <div class="project-image-container">
                <img src="{{ url_for('static', filename=p.IMAGE) if p.IMAGE else url_for('static', filename='images/uploads/projects/default-project.jpg') }}" 
                     alt="{{ p.NAME_PROJECT }}" class="project-image">
            </div>
            <div class="project-details">
                <h3 class="project-title">{{ p.NAME_PROJECT }}</h3>
                
                <div class="project-meta">
                    <h2 class="status-badge">{{ p.STATE }}</h2>
                </div>
                <div class="project-meta">
                    <i class="fas fa-user me-1"></i>
                    {{ user.FULL_NAME if user else 'Unknown User' }}
                </div>
                
                <div class="project-dates">
                    <i class="far fa-calendar-alt me-1"></i>
                    <span class="date-values">
                        {{ p.DATE_BEGIN|datetimeformat('%B %d, %Y') if p.DATE_BEGIN else 'N/A' }} -
                        {{ p.DATE_END|datetimeformat('%B %d, %Y') if p.DATE_END else 'N/A' }}
                    </span>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div class="project-budget">
                        ${{ "{:,.2f}".format(p.BUDGET) if p.BUDGET else '0.00' }}
                    </div>
                    
                    <div class="card-actions">
                        <button class="btn-action btn-update" 
                                data-project-id="{{ p.id }}"
                                data-name="{{ p.NAME_PROJECT if p.NAME_PROJECT else '' }}"
                                data-date-begin="{{ p.DATE_BEGIN if p.DATE_BEGIN else '' }}"
                                data-date-end="{{ p.DATE_END if p.DATE_END else '' }}"
                                data-state="{{ p.STATE if p.STATE else 'Not Started' }}"
                                data-budget="{{ p.BUDGET if p.BUDGET else '0.00' }}"
                                data-image="{{ url_for('static', filename=p.IMAGE) if p.IMAGE else '' }}">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn-action btn-quit" onclick="quit_project({{ p.id }})" data-project-id="{{ p.id }}">
                            <i class="fas fa-sign-out-alt me-1"></i>Quit
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info mt-4">
        <i class="fas fa-info-circle me-2"></i>No projects found. Create your first project using the button above.
    </div>
    {% endif %}

    <!-- Update Profile Modal -->
    <div class="modal fade" id="updateProfileModal" tabindex="-1" aria-labelledby="updateProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateProfileModalLabel">Update Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateProfileForm" method="PUT" enctype="multipart/form-data">
                        <div class="form-group mb-3">
                            <label for="full_name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="full_name" name="full_name" value="{{ user.FULL_NAME if user and user.FULL_NAME else '' }}" required>
                        </div>
                        <div class="form-group mb-3">
                            <label for="bio" class="form-label">Bio</label>
                            <textarea class="form-control" id="bio" name="bio" rows="4">{{ user.BIO if user and user.BIO else '' }}</textarea>
                        </div>
                        <div class="form-group mb-3">
                            <label for="Grade" class="form-label">Grade</label>
                            <select class="form-control" id="Grade" name="Grade">
                                <option value="No grade" {% if user and not user.GRADE %}selected{% endif %}>No Grade</option>
                                {% for grade in grades %}
                                    <option value="{{ grade.id }}">{{ grade.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="image" class="form-label">Profile Picture</label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/*">
                            <small class="text-muted">Recommended size: 100x100px (JPG, PNG, SVG)</small>
                            {% if user and user.IMAGE %}
                            <div class="mt-2">
                                <small>Current Image:</small>
                                <img src="{{ url_for('static', filename=user.IMAGE) }}" class="img-thumbnail mt-1" style="max-height: 80px;">
                            </div>
                            {% endif %}
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <span id="updateProfileButtonText">Update Profile</span>
                                <div class="spinner" id="updateProfileSpinner" style="display: none;"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quit Profile Confirmation Modal -->
    <div id="quitProfileModal" class="modal">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Confirm Quit Profile</h2>
                <button id="closeQuitModal" class="btn-close"></button>
            </div>
            <p>Are you sure you want to deactivate your profile? This will mark your account as inactive, and you will lose access to manage projects and other features. This action can only be undone by an administrator.</p>
            <div class="d-flex justify-content-end mt-4">
                <button type="button" id="cancelQuitModal" class="btn-cancel">Cancel</button>
                <button id="confirmQuitProfile" class="btn btn-danger">
                    <span id="quitButtonText">Confirm Quit</span>
                    <div class="spinner" id="quitSpinner" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Add New Project</h2>
                <button id="closeAddModal" class="btn-close"></button>
            </div>
            
            <form id="addProjectForm" method="POST" action="{{ url_for('projects.create_project') }}" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="name_project" class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="name_project" name="name_project" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="budget" class="form-label">Budget ($)</label>
                        <input type="number" step="0.01" class="form-control" id="budget" name="budget" required>
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="state" class="form-label">Status</label>
                        <select class="form-control" id="state" name="state" required>
                            <option value="Not Started">Not Started</option>
                            <option value="Canceled">Canceled</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="date_begin" class="form-label">Start Date</label>
                        <input type="text" class="form-control datepicker" id="date_begin" name="date_begin" required>
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="date_end" class="form-label">End Date</label>
                        <input type="text" class="form-control datepicker" id="date_end" name="date_end">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="image" class="form-label">Project Image</label>
                    <input type="file" class="form-control" id="image" name="image" accept="image/*">
                    <small class="text-muted">Recommended size: 800x450px (JPG, PNG, SVG)</small>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" id="cancelAddModal" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="addButtonText">Create Project</span>
                        <div class="spinner" id="addSpinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update Project Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Update Project</h2>
                <button id="closeUpdateModal" class="btn-close"></button>
            </div>
            
            <form id="updateProjectForm" method="PUT" enctype="multipart/form-data">
                <input type="hidden" id="updateProjectId" name="project_id">
                
                <div class="form-group">
                    <label for="updateName" class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="updateName" name="name_project" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="updateBudget" class="form-label">Budget ($)</label>
                        <input type="number" step="0.01" class="form-control" id="updateBudget" name="budget" required>
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="updateState" class="form-label">Status</label>
                        <select class="form-control" id="updateState" name="state" required>
                            <option value="Not Started">Not Started</option>
                            <option value="Canceled">Canceled</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="updateDateBegin" class="form-label">Start Date</label>
                        <input type="text" class="form-control datepicker" id="updateDateBegin" name="date_begin" required>
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="updateDateEnd" class="form-label">End Date</label>
                        <input type="text" class="form-control datepicker" id="updateDateEnd" name="date_end">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="updateImage" class="form-label">Update Image</label>
                    <input type="file" class="form-control" id="updateImage" name="image" accept="image/*">
                    <div class="mt-2" id="currentImageContainer">
                        <small>Current Image:</small>
                        <img id="currentImagePreview" src="" class="img-thumbnail mt-1" style="max-height: 80px;">
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" id="cancelUpdateModal" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <span id="updateButtonText">Update Project</span>
                        <div class="spinner" id="updateSpinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Initialize date pickers
            flatpickr('.datepicker', {
                dateFormat: "Y-m-d",
                allowInput: true
            });
    
            // Check if Bootstrap is loaded
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap JavaScript is not loaded. Update Profile modal may not work.');
            }
    
            // Profile Form Submission
            const updateProfileForm = document.getElementById('updateProfileForm');
            const updateProfileButtonText = document.getElementById('updateProfileButtonText');
            const updateProfileSpinner = document.getElementById('updateProfileSpinner');
            const userId = {{ user.id | safe if user else 0 }};
    
            if (updateProfileForm) {
                updateProfileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    
                    updateProfileButtonText.textContent = 'Updating...';
                    updateProfileSpinner.style.display = 'inline-block';
                    
                    fetch(`/api/user/${userId}`, {
                        method: 'PUT',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.error || 'Update failed');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('updateProfileModal'));
                            if (modal) modal.hide();
                            alert('Profile updated successfully!');
                            window.location.reload();
                        } else {
                            alert(data.error || 'Failed to update profile. Please check the form data.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while updating the profile: ' + error.message);
                    })
                    .finally(() => {
                        updateProfileButtonText.textContent = 'Update Profile';
                        updateProfileSpinner.style.display = 'none';
                    });
                });
            }
    
            // Quit Profile Modal
            const quitProfileModal = document.getElementById('quitProfileModal');
            const openQuitModal = document.getElementById('openQuitModal');
            const closeQuitModal = document.getElementById('closeQuitModal');
            const cancelQuitModal = document.getElementById('cancelQuitModal');
            const confirmQuitProfile = document.getElementById('confirmQuitProfile');
            const quitButtonText = document.getElementById('quitButtonText');
            const quitSpinner = document.getElementById('quitSpinner');
    
            function openModal(modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
    
            function closeModal(modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
    
            if (openQuitModal) {
                openQuitModal.addEventListener('click', () => openModal(quitProfileModal));
            }
            if (closeQuitModal) {
                closeQuitModal.addEventListener('click', () => closeModal(quitProfileModal));
            }
            if (cancelQuitModal) {
                cancelQuitModal.addEventListener('click', () => closeModal(quitProfileModal));
            }
            window.addEventListener('click', (e) => {
                if (e.target === quitProfileModal) closeModal(quitProfileModal);
            });
    
            if (confirmQuitProfile) {
                confirmQuitProfile.addEventListener('click', function() {
                    quitButtonText.textContent = 'Deactivating...';
                    quitSpinner.style.display = 'inline-block';
                    
                    fetch(`/user/${userId}/quit`, {
                        method: 'PATCH'
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            closeModal(quitProfileModal);
                            alert('Profile deactivated successfully! You will be logged out.');
                            window.location.href = '/logout';
                        } else {
                            alert(data.error || 'Failed to deactivate profile');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deactivating the profile');
                    })
                    .finally(() => {
                        quitButtonText.textContent = 'Confirm Quit';
                        quitSpinner.style.display = 'none';
                    });
                });
            }
    
            // Project Management
            const addModal = document.getElementById('addModal');
            const updateModal = document.getElementById('updateModal');
            const openAddModal = document.getElementById('openAddModal');
            const closeAddModal = document.getElementById('closeAddModal');
            const cancelAddModal = document.getElementById('cancelAddModal');
            const closeUpdateModal = document.getElementById('closeUpdateModal');
            const cancelUpdateModal = document.getElementById('cancelUpdateModal');
            const addForm = document.getElementById('addProjectForm');
            const updateForm = document.getElementById('updateProjectForm');
            const addSpinner = document.getElementById('addSpinner');
            const addButtonText = document.getElementById('addButtonText');
            const updateSpinner = document.getElementById('updateSpinner');
            const updateButtonText = document.getElementById('updateButtonText');
    
            if (openAddModal) {
                openAddModal.addEventListener('click', () => openModal(addModal));
            }
            if (closeAddModal) {
                closeAddModal.addEventListener('click', () => closeModal(addModal));
            }
            if (closeUpdateModal) {
                closeUpdateModal.addEventListener('click', () => closeModal(updateModal));
            }
            if (cancelAddModal) {
                cancelAddModal.addEventListener('click', () => closeModal(addModal));
            }
            if (cancelUpdateModal) {
                cancelUpdateModal.addEventListener('click', () => closeModal(updateModal));
            }
    
            window.addEventListener('click', (e) => {
                if (e.target === addModal) closeModal(addModal);
                if (e.target === updateModal) closeModal(updateModal);
            });
    
            document.querySelectorAll('.btn-update').forEach(button => {
                button.addEventListener('click', function() {
                    const projectId = this.getAttribute('data-project-id');
                    const currentImage = this.getAttribute('data-image');
                    
                    document.getElementById('updateProjectId').value = projectId;
                    document.getElementById('updateName').value = this.getAttribute('data-name');
                    document.getElementById('updateBudget').value = this.getAttribute('data-budget');
                    document.getElementById('updateDateBegin').value = this.getAttribute('data-date-begin');
                    document.getElementById('updateDateEnd').value = this.getAttribute('data-date-end');
                    document.getElementById('updateState').value = this.getAttribute('data-state');
                    
                    const currentImagePreview = document.getElementById('currentImagePreview');
                    const currentImageContainer = document.getElementById('currentImageContainer');
                    
                    if (currentImage) {
                        currentImagePreview.src = currentImage;
                        currentImageContainer.style.display = 'block';
                    } else {
                        currentImageContainer.style.display = 'none';
                    }
                    
                    openModal(updateModal);
                });
            });
    
            if (addForm) {
                addForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    formData.append('id_user', userId);
                    
                    addButtonText.textContent = 'Creating...';
                    addSpinner.style.display = 'inline-block';
                    
                    fetch("{{ url_for('projects.create_project') }}", {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            closeModal(addModal);
                            alert('Project created successfully!');
                            window.location.reload();
                        } else {
                            alert(data.error || 'Failed to create project. Please check the form data.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while creating the project');
                    })
                    .finally(() => {
                        addButtonText.textContent = 'Create Project';
                        addSpinner.style.display = 'none';
                    });
                });
            }
    
            if (updateForm) {
                updateForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const projectId = document.getElementById('updateProjectId').value;
                    
                    updateButtonText.textContent = 'Updating...';
                    updateSpinner.style.display = 'inline-block';
                    
                    fetch(`/api/project/${projectId}`, {
                        method: 'PUT',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            closeModal(updateModal);
                            alert('Project updated successfully!');
                            window.location.reload();
                        } else {
                            alert(data.error || 'Failed to update project. Please check the form data.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while updating the project');
                    })
                    .finally(() => {
                        updateButtonText.textContent = 'Update Project';
                        updateSpinner.style.display = 'none';
                    });
                });
            }
    
            window.quit_project = function(id) {
                if (confirm('Are you sure you want to quit managing this project? This action cannot be undone.')) {
                    fetch(`/api/project/${id}/quit`, {
                        method: 'PATCH'
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alert('Successfully quit project!');
                            window.location.reload();
                        } else {
                            alert(data.error || 'Failed to quit project');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while quitting the project');
                    });
                }
            };
        } catch (error) {
            console.error('Script error:', error);
        }
    });
</script>
{% endblock %}