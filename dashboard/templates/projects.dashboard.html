{% extends "dashboard.html" %}

{% block head %} 
    <title>Dashboard | Projects</title>
    <link href="{{ url_for('dashboard.static', filename='css/style1.css') }}" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('dashboard.static', filename='css/project-style.css') }}">
    <link rel="stylesheet" href="{{ url_for('dashboard.static', filename='css/flatpickr.min.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Projects Management</h1>
        <button id="openAddModal" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Add Project
        </button>
    </div>
    
    <!-- Add Project Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Add New Project</h2>
                <button id="closeAddModal" class="btn-close" aria-label="Close"></button>
            </div>
            
            <form id="addProjectForm" method="POST" action="{{ url_for('projects.create_project') }}" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="name_project" class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="name_project" name="name_project" >
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="id_manager" class="form-label">Manager</label>
                        <select class="form-control" id="id_manager" name="id_manager" >
                            <option value="">Select Manager</option>
                            {% for researcher in researchers %}
                                <option value="{{ researcher.id_researcher }}">{{ researcher.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="budget" class="form-label">Budget ($)</label>
                        <input type="number" step="0.01" class="form-control" id="budget" name="budget" >
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="date_begin" class="form-label">Start Date</label>
                        <input type="text" class="form-control datepicker" id="date_begin" name="date_begin" >
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="date_end" class="form-label">End Date</label>
                        <input type="text" class="form-control datepicker" id="date_end" name="date_end" >
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="state" class="form-label">Status</label>
                    <select class="form-control" id="state" name="state" >
                        <option value="0">Not Started</option>
                        <option value="1">Canceled</option>
                        <option value="2">In Progress</option>
                        <option value="3">Completed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="image" class="form-label">Project Image</label>
                    <input type="file" class="form-control" id="image" name="image" accept="image/*">
                    <small class="text-muted">Recommended size: 800x450px (JPG, PNG, SVG)</small>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" id="cancelAddModal" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="addButtonText">Create Project</span>
                        <div class="spinner" id="addSpinner" role="status" aria-hidden="true"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update Project Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Update Project</h2>
                <button id="closeUpdateModal" class="btn-close" aria-label="Close"></button>
            </div>
            
            <form id="updateProjectForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="updateProjectId" name="project_id">
                
                <div class="form-group">
                    <label for="updateName" class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="updateName" name="name_project" >
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="updateManager" class="form-label">Manager</label>
                        <select class="form-control" id="updateManager" name="id_manager" >
                            {% for researcher in researchers %}
                                <option value="{{ researcher.id_researcher }}">{{ researcher.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="updateBudget" class="form-label">Budget ($)</label>
                        <input type="number" step="0.01" class="form-control" id="updateBudget" name="budget" >
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="updateDateBegin" class="form-label">Start Date</label>
                        <input type="text" class="form-control datepicker" id="updateDateBegin" name="date_begin" >
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="updateDateEnd" class="form-label">End Date</label>
                        <input type="text" class="form-control datepicker" id="updateDateEnd" name="date_end" >
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="updateState" class="form-label">Status</label>
                    <select class="form-control" id="updateState" name="state" >
                        <option value="0">Not Started</option>
                        <option value="1">Canceled</option>
                        <option value="2">In Progress</option>
                        <option value="3">Completed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="updateImage" class="form-label">Update Image</label>
                    <input type="file" class="form-control" id="updateImage" name="image" accept="image/*">
                    <div class="mt-2" id="currentImageContainer">
                        <small>Current Image:</small>
                        <img id="currentImagePreview" src="" class="img-thumbnail mt-1" style="max-height: 80px;">
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" id="cancelUpdateModal" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <span id="updateButtonText">Update Project</span>
                        <div class="spinner" id="updateSpinner" role="status" aria-hidden="true"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Projects Grid -->
    <div id="projectsGrid" class="projects-grid">
        <!-- Project cards will be dynamically inserted here -->
    </div>
    <div id="noProjectsMessage" class="alert alert-info mt-4" style="display:none;">
        <i class="fas fa-info-circle me-2"></i>No projects found. Create your first project using the button above.
    </div>
</div>

<!-- JavaScript -->
<script src="{{ url_for('dashboard.static', filename='js/flatpickr.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Log initialization
    console.log('Project management script initialized');

    // Initialize Flatpickr
    try {
        flatpickr('.datepicker', {
            dateFormat: 'Y-m-d',
            allowInput: true
        });
        console.log('Flatpickr initialized');
    } catch (e) {
        console.error('Flatpickr initialization failed:', e);
    }

    // Modal elements
    const addModal = document.getElementById('addModal');
    const updateModal = document.getElementById('updateModal');
    const addForm = document.getElementById('addProjectForm');
    const updateForm = document.getElementById('updateProjectForm');
    const addSpinner = document.getElementById('addSpinner');
    const updateSpinner = document.getElementById('updateSpinner');
    const addButtonText = document.getElementById('addButtonText');
    const updateButtonText = document.getElementById('updateButtonText');

    // Check modal elements
    if (!addModal || !updateModal || !addForm || !updateForm || !addSpinner || !updateSpinner || !addButtonText || !updateButtonText) {
        console.error('One or more modal/form elements not found:', {
            addModal: !!addModal,
            updateModal: !!updateModal,
            addForm: !!addForm,
            updateForm: !!updateForm,
            addSpinner: !!addSpinner,
            updateSpinner: !!updateSpinner,
            addButtonText: !!addButtonText,
            updateButtonText: !!updateButtonText
        });
        return;
    }

    // Centralized modal toggle function
    function toggleModal(modal, show) {
        modal.style.display = show ? 'block' : 'none';
        document.body.style.overflow = show ? 'hidden' : 'auto';
        console.log(`Toggled modal ${modal.id} to ${show ? 'visible' : 'hidden'}`);
    }

    // Event listeners for modal buttons
    const openAddModal = document.getElementById('openAddModal');
    const closeAddModal = document.getElementById('closeAddModal');
    const cancelAddModal = document.getElementById('cancelAddModal');
    const closeUpdateModal = document.getElementById('closeUpdateModal');
    const cancelUpdateModal = document.getElementById('cancelUpdateModal');

    if (openAddModal) {
        openAddModal.addEventListener('click', () => {
            console.log('Add Project button clicked');
            toggleModal(addModal, true);
        });
    } else {
        console.error('Open Add Modal button not found');
    }

    if (closeAddModal) {
        closeAddModal.addEventListener('click', () => {
            console.log('Close Add Modal button clicked');
            toggleModal(addModal, false);
        });
    } else {
        console.error('Close Add Modal button not found');
    }

    if (cancelAddModal) {
        cancelAddModal.addEventListener('click', () => {
            console.log('Cancel Add Modal button clicked');
            toggleModal(addModal, false);
        });
    } else {
        console.error('Cancel Add Modal button not found');
    }

    if (closeUpdateModal) {
        closeUpdateModal.addEventListener('click', () => {
            console.log('Close Update Modal button clicked');
            toggleModal(updateModal, false);
        });
    } else {
        console.error('Close Update Modal button not found');
    }

    if (cancelUpdateModal) {
        cancelUpdateModal.addEventListener('click', () => {
            console.log('Cancel Update Modal button clicked');
            toggleModal(updateModal, false);
        });
    } else {
        console.error('Cancel Update Modal button not found');
    }

    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === addModal) {
            console.log('Clicked outside Add Modal');
            toggleModal(addModal, false);
        }
        if (e.target === updateModal) {
            console.log('Clicked outside Update Modal');
            toggleModal(updateModal, false);
        }
    });

    // Image validation
    function validateImageInput(input) {
        if (!input) {
            console.error('Image input element not found');
            return;
        }
        const maxSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ['image/jpeg', 'image/png', 'image/svg+xml'];

        input.addEventListener('change', function(e) {
            console.log('Image input changed');
            const file = e.target.files[0];
            if (file) {
                if (!allowedTypes.includes(file.type)) {
                    alert('Only JPG, PNG, or SVG files are allowed');
                    e.target.value = '';
                } else if (file.size > maxSize) {
                    alert('File size must be less than 5MB');
                    e.target.value = '';
                }
            }
        });
    }

    validateImageInput(document.getElementById('image'));
    validateImageInput(document.getElementById('updateImage'));

    // Form validation
    function validateForm({ dateBeginId, dateEndId, budgetId }) {
        const dateBeginInput = document.getElementById(dateBeginId);
        const dateEndInput = document.getElementById(dateEndId);
        const budgetInput = document.getElementById(budgetId);

        if (!dateBeginInput || !dateEndInput || !budgetInput) {
            console.error('Form input elements not found:', { dateBeginId, dateEndId, budgetId });
            alert('Form configuration error. Please contact support.');
            return false;
        }

        const dateBegin = new Date(dateBeginInput.value);
        const dateEnd = new Date(dateEndInput.value);
        const budget = parseFloat(budgetInput.value);

        if (isNaN(dateBegin) || isNaN(dateEnd)) {
            alert('Please enter valid dates');
            return false;
        }
        if (dateBegin >= dateEnd) {
            alert('End date must be after start date');
            return false;
        }
        if (isNaN(budget) || budget < 0) {
            alert('Budget must be a non-negative number');
            return false;
        }
        return true;
    }

    // Add project form submission
    addForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Add project form submitted');

        if (!validateForm({
            dateBeginId: 'date_begin',
            dateEndId: 'date_end',
            budgetId: 'budget'
        })) return;

        const formData = new FormData(this);
        addButtonText.textContent = 'Creating...';
        addSpinner.style.display = 'inline-block';

        try {
            const response = await fetch(addForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `HTTP error ${response.status}`);
            if (data.success) {
                console.log('Project created successfully');
                toggleModal(addModal, false);
                loadProjects(); // Reload projects after adding
            } else {
                throw new Error(data.error || 'Failed to create project');
            }
        } catch (error) {
            console.error('Error creating project:', error);
            alert(`Error creating project: ${error.message}`);
        } finally {
            addButtonText.textContent = 'Create Project';
            addSpinner.style.display = 'none';
        }
    });

    // Update project button handlers
    const updateButtons = document.querySelectorAll('.btn-update');
    if (updateButtons.length === 0) {
        console.warn('No update buttons found');
    }
    updateButtons.forEach(button => {
        button.addEventListener('click', function() {
            console.log('Update button clicked for project ID:', this.getAttribute('data-project-id'));

            const projectId = this.getAttribute('data-project-id');
            const currentImage = this.getAttribute('data-image');

            const updateProjectId = document.getElementById('updateProjectId');
            const updateName = document.getElementById('updateName');
            const updateManager = document.getElementById('updateManager');
            const updateBudget = document.getElementById('updateBudget');
            const updateDateBegin = document.getElementById('updateDateBegin');
            const updateDateEnd = document.getElementById('updateDateEnd');
            const updateState = document.getElementById('updateState');
            const currentImagePreview = document.getElementById('currentImagePreview');
            const currentImageContainer = document.getElementById('currentImageContainer');

            if (!updateProjectId || !updateName || !updateManager || !updateBudget || 
                !updateDateBegin || !updateDateEnd || !updateState) {
                console.error('Update form elements not found');
                alert('Form configuration error. Please contact support.');
                return;
            }

            updateProjectId.value = projectId;
            updateName.value = this.getAttribute('data-name');
            updateManager.value = this.getAttribute('data-manager');
            updateBudget.value = this.getAttribute('data-budget');
            updateDateBegin.value = this.getAttribute('data-date-begin');
            updateDateEnd.value = this.getAttribute('data-date-end');
            updateState.value = this.getAttribute('data-state');

            if (currentImage) {
                currentImagePreview.src = currentImage;
                currentImageContainer.style.display = 'block';
            } else {
                currentImageContainer.style.display = 'none';
            }

            toggleModal(updateModal, true);
        });
    });

    // Update project form submission
    updateForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Update project form submitted');

        if (!validateForm({
            dateBeginId: 'updateDateBegin',
            dateEndId: 'updateDateEnd',
            budgetId: 'updateBudget'
        })) return;

        const formData = new FormData(this);
        const projectId = document.getElementById('updateProjectId').value;
        updateButtonText.textContent = 'Updating...';
        updateSpinner.style.display = 'inline-block';

        try {
            const response = await fetch(`/api/project/${projectId}`, {
                method: 'PUT',
                body: formData,
                headers: {
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `HTTP error ${response.status}`);
            if (data.success) {
                console.log('Project updated successfully');
                toggleModal(updateModal, false);
                loadProjects(); // Reload projects after updating
            } else {
                throw new Error(data.error || 'Failed to create project');
            }
        } catch (error) {
            console.error('Error updating project:', error);
            alert(`Error updating project: ${error.message}`);
        } finally {
            updateButtonText.textContent = 'Update Project';
            updateSpinner.style.display = 'none';
        }
    });

    // Delete project handler with event delegation
    const projectsGrid = document.getElementById('projectsGrid');
    if (projectsGrid) {
        projectsGrid.addEventListener('click', async function(e) {
            const deleteButton = e.target.closest('.btn-delete');
            if (deleteButton) {
                const projectId = deleteButton.dataset.projectId;
                console.log('Delete button clicked for project ID:', projectId);

                if (confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
                    try {
                        const response = await fetch(`/api/project/${projectId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                            }
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || `HTTP error ${response.status}`);
                        if (data.success) {
                            console.log('Project deleted successfully');
                            loadProjects(); // Reload projects after deleting
                        } else {
                            throw new Error(data.error || 'Failed to delete project');
                        }
                    } catch (error) {
                        console.error('Error deleting project:', error);
                        alert(`Error deleting project: ${error.message}`);
                    }
                }
            }
        });
    } else {
        console.error('Projects grid not found');
    }

    // Function to create project card HTML
    function createProjectCard(p) {
        const stateClasses = ['status-not-started', 'status-canceled', 'status-in-progress', 'status-completed'];
        const stateTexts = ['Not Started', 'Canceled', 'In Progress', 'Completed'];
        const stateClass = stateClasses[p.STATUS] || 'status-not-started';
        const stateText = stateTexts[p.STATUS] || 'Not Started';

        const dateBegin = p.DATE_BEGIN ? new Date(p.DATE_BEGIN).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
        const dateEnd = p.DATE_END ? new Date(p.DATE_END).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';

        const budget = p.BUDGET ? p.BUDGET.toFixed(2) : '0.00';

        const imageUrl = p.IMAGE ? `{{ url_for('static', filename='') }}${p.IMAGE}` : '{{ url_for('static', filename='images/default-project.jpg') }}';

        return `
        <div class="project-card" data-project-id="${p.ID_PROJECT}">
            <div class="project-image-container">
                <img src="${imageUrl}" alt="${p.NAME_PROJECT}" class="project-image">
            </div>
            <div class="project-details">
                <h3 class="project-title">${p.NAME_PROJECT}</h3>
                
                <div class="project-meta">
                    <span class="status-badge ${stateClass}">
                        ${stateText}
                    </span>
                </div>
                
                <div class="project-dates">
                    <i class="far fa-calendar-alt me-1"></i>
                    ${dateBegin} - ${dateEnd}
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div class="project-budget">
                        $${budget}
                    </div>
                    
                    <div class="card-actions">
                        <button class="btn-action btn-update" 
                            data-project-id="${p.ID_PROJECT}"
                            data-name="${p.NAME_PROJECT}"
                            data-manager="${p.ID_MANAGER}"
                            data-date-begin="${p.DATE_BEGIN || ''}"
                            data-date-end="${p.DATE_END || ''}"
                            data-state="${p.STATUS}" 
                            data-budget="${p.BUDGET}"
                            data-image="${imageUrl}">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn-action btn-delete" data-project-id="${p.ID_PROJECT}">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // Function to load projects from API and render cards
    async function loadProjects() {
        try {
            const response = await fetch('/api/project/');
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            const projects = await response.json();

            const projectsGrid = document.getElementById('projectsGrid');
            const noProjectsMessage = document.getElementById('noProjectsMessage');

            if (projects.length === 0) {
                projectsGrid.innerHTML = '';
                noProjectsMessage.style.display = 'block';
                return;
            }

            noProjectsMessage.style.display = 'none';

            projectsGrid.innerHTML = projects.map(createProjectCard).join('');

            // Re-attach update button event listeners after rendering
            const updateButtons = document.querySelectorAll('.btn-update');
            updateButtons.forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Update button clicked for project ID:', this.getAttribute('data-project-id'));

                    const projectId = this.getAttribute('data-project-id');
                    const currentImage = this.getAttribute('data-image');

                    const updateProjectId = document.getElementById('updateProjectId');
                    const updateName = document.getElementById('updateName');
                    const updateManager = document.getElementById('updateManager');
                    const updateBudget = document.getElementById('updateBudget');
                    const updateDateBegin = document.getElementById('updateDateBegin');
                    const updateDateEnd = document.getElementById('updateDateEnd');
                    const updateState = document.getElementById('updateState');
                    const currentImagePreview = document.getElementById('currentImagePreview');
                    const currentImageContainer = document.getElementById('currentImageContainer');

                    if (!updateProjectId || !updateName || !updateManager || !updateBudget || 
                        !updateDateBegin || !updateDateEnd || !updateState) {
                        console.error('Update form elements not found');
                        alert('Form configuration error. Please contact support.');
                        return;
                    }

                    updateProjectId.value = projectId;
                    updateName.value = this.getAttribute('data-name');
                    updateManager.value = this.getAttribute('data-manager');
                    updateBudget.value = this.getAttribute('data-budget');
                    updateDateBegin.value = this.getAttribute('data-date-begin');
                    updateDateEnd.value = this.getAttribute('data-date-end');
                    updateState.value = this.getAttribute('data-state');

                    if (currentImage) {
                        currentImagePreview.src = currentImage;
                        currentImageContainer.style.display = 'block';
                    } else {
                        currentImageContainer.style.display = 'none';
                    }

                    toggleModal(updateModal, true);
                });
            });

        } catch (error) {
            console.error('Error loading projects:', error);
            alert(`Error loading projects: ${error.message}`);
        }
    }

    // Initial load of projects
    loadProjects();
});
</script>
{% endblock %}
