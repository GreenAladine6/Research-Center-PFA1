{% extends "user.html" %}

{% block head %}
    <title>Dashboard | Profile</title>
    <link href="{{ url_for('dashboard.static', filename='css/style1.css') }}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">User Profile</h1>
    <div class="card">
        <div class="card-body">
            <form id="updateProfileForm" method="POST" action="{{ url_for('user.update_profile') }}" enctype="multipart/form-data">
                <div class="form-group mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" value="{{ user.MAIL if user else '' }}">
                </div>
                <div class="form-group mb-3">
                    <label for="password" class="form-label">New Password</label>
                    <input type="password" class="form-control" id="password" name="password">
                    <small class="text-muted">Minimum 8 characters</small>
                </div>
                <div class="form-group mb-3">
                    <label for="confirm_password" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="confirm_password" name="confirm_password">
                </div>
                <div class="form-group mb-3">
                    <label for="image" class="form-label">Profile Picture</label>
                    <input type="file" class="form-control" id="image" name="image" accept="image/*">
                    <small class="text-muted">Recommended size: 100x100px (JPG, PNG, SVG)</small>
                    {% if user and user.IMAGE %}
                    <div class="mt-2">
                        <small>Current Image:</small>
                        <img src="{{ url_for('static', filename=user.IMAGE[7:]) }}" alt="Profile Picture" class="img-thumbnail" style="max-height: 80px;">
                    </div>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">
                        <span id="updateButtonText">Update Profile</span>
                        <div class="spinner" id="updateSpinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const updateForm = document.getElementById('updateProfileForm');
        const updateButtonText = document.getElementById('updateButtonText');
        const updateSpinner = document.getElementById('updateSpinner');

        updateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            updateButtonText.textContent = 'Updating...';
            updateSpinner.style.display = 'inline-block';
            
            fetch("{{ url_for('user.update_profile') }}", {
                method: 'PUT',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.error || 'Failed to update profile. Please check the form data.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the profile');
            })
            .finally(() => {
                updateButtonText.textContent = 'Update Profile';
                updateSpinner.style.display = 'none';
            });
        });
    });
</script>
{% endblock %}